name: CI Guardrails

on:
  pull_request:
  push:
    branches: [ main ]

# Set minimal permissions for security
permissions:
  contents: read

jobs:
  no-placeholders:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Fail if placeholder keywords exist outside tests
        run: |
          set -e
          # Only scan non-test code; adjust exclusions as needed
          # If ripgrep isn't present, install it.
          if ! command -v rg >/dev/null 2>&1; then sudo apt-get update && sudo apt-get install -y ripgrep; fi
          echo "Scanning for placeholder keywords outside tests..."
          rg -n --hidden --no-ignore-vcs \
            -S "(TODO|FIXME|HACK|STUB|MOCK|PLACEHOLDER|COMING SOON|dummy data|fake success)" \
            . \
            --glob "!tests/**" \
            --glob "!.git/**" \
            --glob "!.github/**" \
            --glob "!dist/**" \
            --glob "!build/**" \
            --glob "!node_modules/**" \
            --glob "!**/__pycache__/**" \
            && { echo "❌ Placeholders found in non-test code. Purge or gate behind EXPERIMENTAL (OFF by default)."; exit 1; } \
            || echo "✅ No placeholder keywords detected outside tests."

  node-python-ci:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Node deps (root if package-lock exists)
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            echo "No package-lock.json at root; skipping npm ci."
          fi

      - name: Run Node tests (if defined)
        run: |
          if [ -f package.json ]; then
            node -e "const p=require('./package.json'); process.exit(p.scripts && p.scripts.test ? 0 : 1)" \
              && npm test \
              || echo "No npm test script; skipping."
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python deps (if requirements exist)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then python -m pip install -r requirements.txt; fi
          # Install pytest for Python test discovery
          python -m pip install pytest || true

      - name: Run Python tests (if Python tests exist)
        run: |
          # Look for Python test files
          if find tests -name "*.py" -type f 2>/dev/null | grep -q .; then
            pytest -q tests
          else
            echo "ℹ️ No Python tests found in tests/ directory."
          fi

      - name: Verify tests directory exists
        run: |
          if [ ! -d tests ]; then
            echo "❌ tests/ directory not found; CI requires real tests. Create tests or correct path."
            exit 1
          fi
          # Ensure at least some test files exist (JS or Python)
          if ! find tests -type f \( -name "*.test.js" -o -name "*.spec.js" -o -name "*.test.ts" -o -name "*.spec.ts" -o -name "test_*.py" -o -name "*_test.py" \) 2>/dev/null | grep -q .; then
            echo "⚠️ No recognized test files found in tests/ directory."
          else
            echo "✅ Test files found in tests/ directory."
          fi
