name: CI Guardrails

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  no-placeholders:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fail if placeholder keywords exist outside tests
        run: |
          set -e
          # Only scan non-test code; adjust exclusions as needed
          # If ripgrep isn't present, install it.
          if ! command -v rg >/dev/null 2>&1; then sudo apt-get update && sudo apt-get install -y ripgrep; fi
          echo "Scanning for placeholder keywords outside tests..."
          rg -n --hidden --no-ignore-vcs \
            -S "(TODO|FIXME|HACK|STUB|MOCK|PLACEHOLDER|COMING SOON|dummy data|fake success)" \
            . \
            --glob "!tests/**" \
            --glob "!.git/**" \
            --glob "!.github/**" \
            --glob "!dist/**" \
            --glob "!build/**" \
            --glob "!node_modules/**" \
            --glob "!**/__pycache__/**" \
            && { echo "❌ Placeholders found in non-test code. Purge or gate behind EXPERIMENTAL (OFF by default)."; exit 1; } \
            || echo "✅ No placeholder keywords detected outside tests."

  node-python-ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Node deps (root if package-lock exists)
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            echo "No package-lock.json at root; skipping npm ci."
          fi

      - name: Run Node tests (if defined)
        run: |
          if [ -f package.json ]; then
            node -e "const p=require('./package.json'); process.exit(p.scripts && p.scripts.test ? 0 : 1)" \
              && npm test \
              || echo "No npm test script; skipping."
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python deps (if requirements exist)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then python -m pip install -r requirements.txt; fi
          # If there are nested requirements, install them only when explicitly present:
          if [ -f bootforge/requirements.txt ]; then python -m pip install -r bootforge/requirements.txt; fi
          python -m pip install pytest || true

      - name: Run Python tests (must actually exist)
        run: |
          if [ -d tests ]; then
            pytest -q tests
          else
            echo "❌ tests/ directory not found; CI requires real tests. Create tests or correct path."
            exit 1
          fi
