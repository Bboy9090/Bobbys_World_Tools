name: Build macOS App

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.0.0)'
        required: false
        default: 'latest'

jobs:
  build-macos:
    name: Build macOS .app Bundle
    runs-on: macos-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: x86_64-apple-darwin
      
      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^1.0"
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build frontend
        run: npm run build
        env:
          NODE_OPTIONS: '--max_old_space_size=4096'
      
      - name: Build macOS .app bundle
        run: cargo tauri build --target x86_64-apple-darwin
      
      - name: Create DMG (if hdiutil available)
        id: create_dmg
        run: |
          # Get version from Cargo.toml
          VERSION=$(grep '^version' src-tauri/Cargo.toml | head -n1 | cut -d'"' -f2)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          
          # Find the .app bundle
          if [ -d "src-tauri/target/release/bundle/macos/Bobbys-Workshop.app" ]; then
            APP_PATH="src-tauri/target/release/bundle/macos/Bobbys-Workshop.app"
          elif [ -d "src-tauri/target/x86_64-apple-darwin/release/bundle/macos/Bobbys-Workshop.app" ]; then
            APP_PATH="src-tauri/target/x86_64-apple-darwin/release/bundle/macos/Bobbys-Workshop.app"
          else
            echo "Error: .app bundle not found"
            exit 1
          fi
          
          # Create DMG
          mkdir -p dist
          DMG_NAME="Bobbys-Workshop-${VERSION}-macOS-x86_64.dmg"
          
          # Create temporary directory
          TMP_DIR=$(mktemp -d)
          cp -R "$APP_PATH" "$TMP_DIR/"
          ln -s /Applications "$TMP_DIR/Applications"
          
          # Create DMG
          hdiutil create -volname "Bobby's Workshop" \
            -srcfolder "$TMP_DIR" \
            -ov -format UDZO \
            "dist/$DMG_NAME"
          
          # Cleanup
          rm -rf "$TMP_DIR"
          
          echo "DMG_NAME=$DMG_NAME" >> $GITHUB_OUTPUT
          echo "DMG_PATH=dist/$DMG_NAME" >> $GITHUB_OUTPUT
        continue-on-error: false
      
      - name: Generate checksums
        run: |
          cd dist
          shasum -a 256 *.dmg > checksums-macos.txt
          cat checksums-macos.txt
      
      - name: Upload .app bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-app-bundle
          path: |
            src-tauri/target/*/release/bundle/macos/*.app
            src-tauri/target/release/bundle/macos/*.app
          retention-days: 7
          if-no-files-found: error
      
      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg-installer
          path: |
            dist/*.dmg
            dist/checksums-macos.txt
          retention-days: 30
          if-no-files-found: error
      
      - name: Create Release (on tag push)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/*.dmg
            dist/checksums-macos.txt
          body: |
            ## Bobby's Workshop - macOS Release
            
            ### Installation Instructions
            
            1. Download `Bobbys-Workshop-${{ steps.create_dmg.outputs.VERSION }}-macOS-x86_64.dmg`
            2. Open the DMG file
            3. Drag Bobby's Workshop to your Applications folder
            4. Launch from Applications
            5. If prompted for security, go to System Preferences â†’ Security & Privacy and allow the app
            
            ### System Requirements
            
            - macOS 10.15 (Catalina) or later
            - 500MB free disk space
            - USB ports for device connectivity
            
            ### Verification
            
            Verify the download integrity using the checksums file:
            ```bash
            shasum -a 256 -c checksums-macos.txt
            ```
            
            ### What's Included
            
            - Native macOS .app bundle
            - All frontend components
            - Backend API server (embedded)
            - WebSocket support
            - USB device detection
            - Complete documentation
            
            See [TAURI_BUILD_GUIDE.md](./TAURI_BUILD_GUIDE.md) for more details.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
