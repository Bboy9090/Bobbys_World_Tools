datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Customer {
  id        String   @id @default(uuid())
  name      String
  phone     String?
  email     String?
  devices   Device[]
  tickets   Ticket[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Device {
  id              String   @id @default(uuid())
  customer        Customer @relation(fields: [customerId], references: [id])
  customerId      String
  platform        String   // 'android' | 'ios' | 'windows'
  oem             String?
  model           String?
  serial          String?
  imei            String?
  label           String?
  diagnosticRuns  DiagnosticRun[]
  tickets         Ticket[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Ticket {
  id                  String   @id @default(uuid())
  customer            Customer @relation(fields: [customerId], references: [id])
  customerId          String
  device              Device   @relation(fields: [deviceId], references: [id])
  deviceId            String
  status              String   @default("intake") // 'intake' | 'diagnosing' | 'estimating' | 'approved' | 'repairing' | 'done' | 'cancelled'
  issueSummary        String?
  notes               String?
  diagnosticRuns      DiagnosticRun[]
  parts               TicketPart[]
  labor               TicketLabor[]
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model DiagnosticRun {
  id        String   @id @default(uuid())
  device    Device   @relation(fields: [deviceId], references: [id])
  deviceId  String
  ticket    Ticket?  @relation(fields: [ticketId], references: [id])
  ticketId  String?
  status    String   @default("completed")
  summary   String
  findings  DiagnosticFinding[]
  createdAt DateTime @default(now())
}

model DiagnosticFinding {
  id         String        @id @default(uuid())
  run        DiagnosticRun @relation(fields: [runId], references: [id])
  runId      String
  level      String        // 'info' | 'warning' | 'critical'
  code       String
  message    String
  source     String        // 'android_storage', 'battery', etc.
  createdAt  DateTime      @default(now())
}

model Part {
  id               String   @id @default(uuid())
  sku              String   @unique
  name             String
  category         String   // 'battery' | 'screen' | 'storage' | etc.
  compatibleOem    String?
  compatibleModel  String?
  costPriceCents   Int
  sellPriceCents   Int
  stockQuantity    Int      @default(0)
  minStockAlert    Int      @default(0)
  tickets          TicketPart[]
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model TicketPart {
  id             String  @id @default(uuid())
  ticket         Ticket  @relation(fields: [ticketId], references: [id])
  ticketId       String
  part           Part    @relation(fields: [partId], references: [id])
  partId         String
  quantity       Int     @default(1)
  linePriceCents Int
  createdAt      DateTime @default(now())
}

model TicketLabor {
  id             String  @id @default(uuid())
  ticket         Ticket  @relation(fields: [ticketId], references: [id])
  ticketId       String
  description    String
  minutes        Int
  rateCents      Int
  linePriceCents Int
  createdAt      DateTime @default(now())
}
