/**
 * Exploit Registry - Modular multi-exploit system by lock type, platform, and strategy
 * FRP, MDM, Jailbreak, iCloud, SIM/Carrier modules with color-coded themes
 * Multiple exploits per lock - "Play it cool" (1-2) vs "Safe but uneasy" (3-6+)
 */

import { useState, useMemo } from 'react';

export interface ExploitMethod {
  id: string;
  name: string;
  description: string;
  difficulty: 'easy' | 'medium' | 'hard' | 'extreme';
  successRate: number;
  price: number;
  requirements: string[];
}

export interface LockIssue {
  id: string;
  name: string;
  description: string;
  methods: ExploitMethod[];
}

export interface ExploitModule {
  id: string;
  name: string;
  category: 'frp' | 'mdm' | 'jailbreak' | 'icloud' | 'carrier' | 'android-security';
  platform: 'ios' | 'android' | 'mac' | 'multi';
  description: string;
  theme: 'codex' | 'zeus' | 'hades' | 'phoenix';
  themeColor: string;
  locks: LockIssue[];
}

interface ExploitRegistryProps {
  onSelectionChange?: (selected: Map<string, Set<string>>, totalStrength: number) => void;
  onExecute?: (selected: Map<string, Set<string>>) => void;
}

const EXPLOIT_MODULES: ExploitModule[] = [
  // ===== FRP MODULE - Hades Gate (Breaking Barriers) =====
  {
    id: 'frp-module',
    name: 'FRP Bypass Solutions',
    category: 'frp',
    platform: 'android',
    description: 'Factory Reset Protection bypass methods by manufacturer',
    theme: 'hades',
    themeColor: 'text-grimoire-abyss-purple',
    locks: [
      {
        id: 'frp-samsung',
        name: 'Samsung FRP Lock',
        description: 'Remove Samsung Account verification after factory reset',
        methods: [
          { id: 'samsung-find-mobile', name: 'Find Mobile Service', description: 'Samsung account bypass via Find Mobile', difficulty: 'easy', successRate: 92, price: 15, requirements: ['Email access', 'USB Cable'] },
          { id: 'samsung-adb-shell', name: 'ADB Shell Method', description: 'Remove FRP via ADB shell commands', difficulty: 'medium', successRate: 88, price: 10, requirements: ['USB Debugging', 'Computer'] },
          { id: 'samsung-bypass-tool', name: 'Bypass Tool', description: 'Automated Samsung FRP removal', difficulty: 'easy', successRate: 95, price: 20, requirements: ['Tool License'] },
          { id: 'samsung-odin', name: 'ODIN Firmware Flash', description: 'Stock firmware flash to remove FRP', difficulty: 'hard', successRate: 98, price: 25, requirements: ['ODIN', 'Stock ROM'] },
        ]
      },
      {
        id: 'frp-xiaomi',
        name: 'Xiaomi FRP Lock',
        description: 'MIUI Account verification bypass',
        methods: [
          { id: 'xiaomi-mi-account', name: 'Mi Account Recovery', description: 'Account password reset via recovery', difficulty: 'easy', successRate: 85, price: 12, requirements: ['Email'] },
          { id: 'xiaomi-fastboot-unlock', name: 'Fastboot Unlock', description: 'Unlock bootloader and skip FRP', difficulty: 'medium', successRate: 90, price: 15, requirements: ['Fastboot', 'Patience'] },
          { id: 'xiaomi-adb-wipe', name: 'ADB Wipe Method', description: 'Wipe FRP data via ADB', difficulty: 'medium', successRate: 87, price: 10, requirements: ['ADB', 'USB'] },
        ]
      },
      {
        id: 'frp-google',
        name: 'Google Account Lock',
        description: 'Android Device Manager / Find My Mobile unlock',
        methods: [
          { id: 'google-recovery-sim', name: 'Recovery + SIM', description: 'Use recovery mode and new SIM', difficulty: 'easy', successRate: 80, price: 0, requirements: ['New SIM'] },
          { id: 'google-browser-sync', name: 'Browser Sync Method', description: 'Sign in via browser to bypass', difficulty: 'easy', successRate: 85, price: 5, requirements: ['Browser Access'] },
          { id: 'google-downgrade', name: 'Downgrade Method', description: 'Downgrade Android version to skip', difficulty: 'hard', successRate: 92, price: 20, requirements: ['Downgrade ROM'] },
        ]
      },
    ]
  },

  // ===== MDM MODULE - Zeus Forge (Powerful Authority Removal) =====
  {
    id: 'mdm-module',
    name: 'MDM Bypass Solutions',
    category: 'mdm',
    platform: 'ios',
    description: 'Mobile Device Management profile removal & escrow code generation',
    theme: 'zeus',
    themeColor: 'text-grimoire-thunder-gold',
    locks: [
      {
        id: 'mdm-lock-ios',
        name: 'iOS MDM Lock',
        description: 'Corporate MDM profile enforcement',
        methods: [
          { id: 'mdm-pbkdf2', name: 'PBKDF2-SHA256 Escrow Code', description: '50,000 iteration code generation (15 day valid)', difficulty: 'easy', successRate: 98, price: 25, requirements: ['A5-A16'] },
          { id: 'mdm-profile-delete', name: 'Profile Direct Deletion', description: 'Remove MDM profile from Settings directly', difficulty: 'easy', successRate: 85, price: 15, requirements: ['Device Access'] },
          { id: 'mdm-dfu-reset', name: 'DFU Mode Full Reset', description: 'Complete device wipe via DFU mode', difficulty: 'medium', successRate: 100, price: 30, requirements: ['Computer', 'Cable'] },
          { id: 'mdm-icloud-backup', name: 'iCloud Backup Restore', description: 'Restore from pre-MDM backup', difficulty: 'easy', successRate: 92, price: 20, requirements: ['iCloud Account'] },
          { id: 'mdm-checkm8', name: 'Checkm8 Bootrom Exploit', description: 'A5-A11 bootrom vulnerability', difficulty: 'extreme', successRate: 100, price: 50, requirements: ['A5-A11', 'Bootrom Access'] },
        ]
      },
      {
        id: 'mdm-macos',
        name: 'macOS MDM Lock',
        description: 'macOS device management restrictions',
        methods: [
          { id: 'mdm-mac-profile-removal', name: 'Profile Removal', description: 'Remove MDM profiles from System Settings', difficulty: 'medium', successRate: 88, price: 20, requirements: ['Admin Access'] },
          { id: 'mdm-mac-erase-install', name: 'Erase & Reinstall', description: 'Full macOS clean install', difficulty: 'hard', successRate: 100, price: 35, requirements: ['Installation Media'] },
        ]
      },
    ]
  },

  // ===== JAILBREAK MODULE - Codex Link (System Enlightenment) =====
  {
    id: 'jailbreak-module',
    name: 'Jailbreak Solutions',
    category: 'jailbreak',
    platform: 'ios',
    description: 'iOS jailbreaking and root access methods',
    theme: 'codex',
    themeColor: 'text-grimoire-electric-blue',
    locks: [
      {
        id: 'jailbreak-a5-a11',
        name: 'A5-A11 Jailbreak',
        description: 'Complete jailbreak for older devices',
        methods: [
          { id: 'jb-checkra1n', name: 'checkra1n', description: 'Checkm8-based persistent jailbreak', difficulty: 'easy', successRate: 99, price: 0, requirements: ['A5-A11', 'Computer'] },
          { id: 'jb-palera1n', name: 'palera1n', description: 'Partial jailbreak with reboot required', difficulty: 'easy', successRate: 97, price: 0, requirements: ['A8-A11'] },
        ]
      },
      {
        id: 'jailbreak-a12plus',
        name: 'A12+ Jailbreak',
        description: 'Recent devices jailbreak options',
        methods: [
          { id: 'jb-unc0ver', name: 'unc0ver', description: 'Full jailbreak for A12-A14', difficulty: 'medium', successRate: 92, price: 10, requirements: ['Computer', 'Time'] },
          { id: 'jb-trollstore', name: 'TrollStore', description: 'Permanent app installation method', difficulty: 'medium', successRate: 95, price: 15, requirements: ['Available exploit'] },
        ]
      },
    ]
  },

  // ===== ICLOUD MODULE - Codex Link (Cloud Veil) =====
  {
    id: 'icloud-module',
    name: 'iCloud & Activation Bypass',
    category: 'icloud',
    platform: 'ios',
    description: 'iCloud lock and Activation Lock removal',
    theme: 'codex',
    themeColor: 'text-grimoire-neon-cyan',
    locks: [
      {
        id: 'icloud-lock',
        name: 'iCloud/FMI Lock',
        description: 'Find My iPhone enabled',
        methods: [
          { id: 'icloud-mina-criss', name: 'Mina Criss A12+ Bypass', description: 'MobileGestalt exploit with activation records', difficulty: 'hard', successRate: 96, price: 35, requirements: ['A12-A16', 'USB', 'Bypass Tool'] },
          { id: 'icloud-checkm8-fmi', name: 'Checkm8 FMI Removal', description: 'Bootrom exploit for FMI bypass', difficulty: 'extreme', successRate: 100, price: 50, requirements: ['A5-A11', 'DFU Mode'] },
          { id: 'icloud-sim-activate', name: 'SIM Activation Bypass', description: 'Activate via new SIM and recovery', difficulty: 'easy', successRate: 85, price: 15, requirements: ['New SIM'] },
        ]
      },
      {
        id: 'activation-lock',
        name: 'Activation Lock',
        description: 'Setup Assistant locked',
        methods: [
          { id: 'act-skip-wifi', name: 'WiFi Skip Method', description: 'Skip Activation Lock via WiFi settings', difficulty: 'easy', successRate: 70, price: 0, requirements: ['WiFi Access'] },
          { id: 'act-icloud-credentials', name: 'Credentials Bypass', description: 'Use stored iCloud credentials', difficulty: 'easy', successRate: 80, price: 10, requirements: ['Credentials'] },
        ]
      },
    ]
  },

  // ===== SIM & CARRIER MODULE - Phoenix Verse (Burning Restrictions) =====
  {
    id: 'sim-carrier-module',
    name: 'SIM & Carrier Unlock',
    category: 'carrier',
    platform: 'multi',
    description: 'Carrier lock removal and SIM unlock',
    theme: 'phoenix',
    themeColor: 'text-grimoire-phoenix-orange',
    locks: [
      {
        id: 'sim-lock-iphone',
        name: 'iPhone SIM Lock',
        description: 'Carrier-locked iPhone',
        methods: [
          { id: 'sim-ultra-sim', name: 'Ultra SIM Card', description: 'Hardware-based SIM unlock', difficulty: 'easy', successRate: 98, price: 20, requirements: ['Ultra SIM'] },
          { id: 'sim-iphone-unlock', name: 'iPhone Carrier Unlock', description: 'Official carrier unlock request', difficulty: 'easy', successRate: 95, price: 15, requirements: ['Account Access'] },
          { id: 'sim-imei-unlock', name: 'IMEI Unlock Service', description: 'IMEI-based carrier unlock', difficulty: 'medium', successRate: 92, price: 25, requirements: ['IMEI', 'Service'] },
        ]
      },
      {
        id: 'sim-lock-android',
        name: 'Android SIM Lock',
        description: 'Android device carrier lock',
        methods: [
          { id: 'sim-android-code', name: 'Unlock Code', description: 'Carrier unlock code entry', difficulty: 'easy', successRate: 90, price: 10, requirements: ['Unlock Code'] },
          { id: 'sim-service-unlock', name: 'Service Provider Unlock', description: 'Third-party unlock service', difficulty: 'easy', successRate: 88, price: 20, requirements: ['Service'] },
        ]
      },
    ]
  },

  // ===== ANDROID SECURITY MODULE - Hades Gate (Dark Realm Access) =====
  {
    id: 'android-security-module',
    name: 'Android Security Bypasses',
    category: 'android-security',
    platform: 'android',
    description: 'Pattern, PIN, biometric, and Knox bypasses',
    theme: 'hades',
    themeColor: 'text-grimoire-abyss-purple',
    locks: [
      {
        id: 'pattern-lock',
        name: 'Pattern/PIN Lock',
        description: 'Device unlock pattern or PIN',
        methods: [
          { id: 'pattern-google-reset', name: 'Google Account Reset', description: 'Reset via Google account', difficulty: 'easy', successRate: 85, price: 0, requirements: ['Google Account'] },
          { id: 'pattern-adb-shell', name: 'ADB Shell Removal', description: 'Remove lock via ADB shell', difficulty: 'medium', successRate: 90, price: 10, requirements: ['USB Debugging'] },
          { id: 'pattern-recovery-wipe', name: 'Recovery Wipe', description: 'Factory reset via recovery', difficulty: 'easy', successRate: 100, price: 0, requirements: ['Recovery Access'] },
        ]
      },
      {
        id: 'knox-lock',
        name: 'Samsung Knox Lock',
        description: 'Knox security platform bypasses',
        methods: [
          { id: 'knox-knox-patch', name: 'Knox Patcher', description: 'Patch Knox via custom kernel', difficulty: 'hard', successRate: 94, price: 30, requirements: ['Custom Kernel'] },
          { id: 'knox-flash-stock', name: 'Stock Flash', description: 'Flash stock ROM to remove Knox', difficulty: 'medium', successRate: 96, price: 20, requirements: ['Stock ROM'] },
        ]
      },
    ]
  },
];

export function ExploitRegistry({ onSelectionChange, onExecute }: ExploitRegistryProps) {
  const [selectedMethods, setSelectedMethods] = useState<Map<string, Set<string>>>(new Map());
  const [expandedModules, setExpandedModules] = useState<Set<string>>(new Set(EXPLOIT_MODULES.map(m => m.id)));
  const [expandedLocks, setExpandedLocks] = useState<Set<string>>(new Set());

  const totalStrength = useMemo(() => {
    let sum = 0;
    selectedMethods.forEach(methods => {
      methods.forEach(methodId => {
        for (const module of EXPLOIT_MODULES) {
          for (const lock of module.locks) {
            const method = lock.methods.find(m => m.id === methodId);
            if (method) {
              sum += method.successRate / 10;
            }
          }
        }
      });
    });
    return Math.min(100, sum);
  }, [selectedMethods]);

  const toggleMethod = (lockId: string, methodId: string) => {
    const newSelected = new Map(selectedMethods);
    if (!newSelected.has(lockId)) {
      newSelected.set(lockId, new Set());
    }
    const lockMethods = newSelected.get(lockId)!;
    if (lockMethods.has(methodId)) {
      lockMethods.delete(methodId);
    } else {
      lockMethods.add(methodId);
    }
    setSelectedMethods(newSelected);
    onSelectionChange?.(newSelected, totalStrength);
  };

  const toggleAllLockMethods = (lockId: string, methods: ExploitMethod[]) => {
    const newSelected = new Map(selectedMethods);
    if (!newSelected.has(lockId)) {
      newSelected.set(lockId, new Set());
    }
    const lockMethods = newSelected.get(lockId)!;
    const allSelected = methods.every(m => lockMethods.has(m.id));
    if (allSelected) {
      methods.forEach(m => lockMethods.delete(m.id));
    } else {
      methods.forEach(m => lockMethods.add(m.id));
    }
    setSelectedMethods(newSelected);
    onSelectionChange?.(newSelected, totalStrength);
  };

  const toggleModule = (moduleId: string) => {
    const newExpanded = new Set(expandedModules);
    if (newExpanded.has(moduleId)) {
      newExpanded.delete(moduleId);
    } else {
      newExpanded.add(moduleId);
    }
    setExpandedModules(newExpanded);
  };

  const toggleLock = (lockId: string) => {
    const newExpanded = new Set(expandedLocks);
    if (newExpanded.has(lockId)) {
      newExpanded.delete(lockId);
    } else {
      newExpanded.add(lockId);
    }
    setExpandedLocks(newExpanded);
  };

  const getDifficultyColor = (difficulty: string) => {
    switch (difficulty) {
      case 'easy': return 'text-green-400';
      case 'medium': return 'text-grimoire-thunder-gold';
      case 'hard': return 'text-grimoire-phoenix-orange';
      case 'extreme': return 'text-red-500 animate-pulse';
      default: return 'text-dark-muted';
    }
  };

  const getThemeStyles = (theme: 'codex' | 'zeus' | 'hades' | 'phoenix') => {
    switch (theme) {
      case 'codex':
        return {
          header: 'bg-electric-glow border-grimoire-electric-blue/40 hover:border-grimoire-electric-blue/60',
          shadow: 'shadow-glow-blue',
          accent: 'text-grimoire-electric-blue'
        };
      case 'zeus':
        return {
          header: 'bg-thunder-strike border-grimoire-thunder-gold/40 hover:border-grimoire-thunder-gold/60',
          shadow: 'shadow-glow-gold',
          accent: 'text-grimoire-thunder-gold'
        };
      case 'hades':
        return {
          header: 'abyss-panel border-grimoire-abyss-purple/40 hover:border-grimoire-abyss-purple/60',
          shadow: 'shadow-glow-purple',
          accent: 'text-grimoire-abyss-purple'
        };
      case 'phoenix':
        return {
          header: 'bg-phoenix-flame border-grimoire-phoenix-orange/40 hover:border-grimoire-phoenix-orange/60',
          shadow: 'shadow-glow-orange',
          accent: 'text-grimoire-phoenix-orange'
        };
    }
  };

  return (
    <div className="space-y-4">
      <div className="grimoire-card p-6">
        <h2 className="text-2xl font-grimoire font-bold text-grimoire-electric-blue mb-2">Exploit Arsenal</h2>
        <p className="text-dark-muted text-sm mb-4">Select exploitation methods for each lock. "Cool & Easy" = 1-2 methods | "Safe but Uneasy" = 3-6+</p>
        <div className="flex items-center gap-4">
          <div>
            <p className="text-xs text-dark-muted mb-1">Bypass Success Strength</p>
            <p className={`text-3xl font-bold font-tech ${totalStrength >= 70 ? 'text-grimoire-electric-blue' : totalStrength >= 40 ? 'text-grimoire-thunder-gold' : 'text-grimoire-phoenix-orange'}`}>{Math.round(totalStrength)}</p>
          </div>
          <div className="flex-1 bg-dark-bg border border-dark-border rounded p-3">
            <div className="w-full bg-dark-border rounded h-2">
              <div className="bg-grimoire-electric-blue h-2 rounded transition-all" style={{ width: `${totalStrength}%` }} />
            </div>
          </div>
        </div>
      </div>

      <div className="space-y-3">
        {EXPLOIT_MODULES.map(module => {
          const themeStyles = getThemeStyles(module.theme);
          return (
          <div key={module.id} className={`border rounded-lg overflow-hidden grimoire-card`}>
            <div className={`${themeStyles.header} border-b border-dark-border p-4 cursor-pointer transition-all`} onClick={() => toggleModule(module.id)}>
              <div className="flex items-center justify-between">
                <div className="flex-1">
                  <h3 className={`font-semibold font-grimoire ${module.themeColor}`}>{module.name}</h3>
                  <p className="text-xs text-dark-muted mt-1">{module.description}</p>
                </div>
                <span className="text-dark-muted transition-transform" style={{ transform: expandedModules.has(module.id) ? 'rotate(180deg)' : 'rotate(0deg)' }}>â–¼</span>
              </div>
            </div>

            {expandedModules.has(module.id) && (
              <div className="divide-y divide-dark-border">
                {module.locks.map(lock => {
                  const lockMethods = selectedMethods.get(lock.id) || new Set();
                  const allSelected = lock.methods.length > 0 && lock.methods.every(m => lockMethods.has(m.id));
                  const isExpanded = expandedLocks.has(lock.id);
                  const themeStyles = getThemeStyles(module.theme);

                  return (
                    <div key={lock.id}>
                      <div className="p-4 hover:bg-dark-border/30 cursor-pointer transition-colors" onClick={() => toggleLock(lock.id)}>
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-3 flex-1">
                            <input
                              type="checkbox"
                              checked={allSelected}
                              onChange={() => toggleAllLockMethods(lock.id, lock.methods)}
                              onClick={(e) => e.stopPropagation()}
                              className={`w-4 h-4 rounded cursor-pointer accent-grimoire-electric-blue`}
                            />
                            <div>
                              <h4 className="font-medium text-dark-text">{lock.name}</h4>
                              <p className="text-xs text-dark-muted">{lock.description}</p>
                            </div>
                          </div>
                          <div className="flex items-center gap-2">
                            <span className={`text-xs font-mono px-2 py-1 rounded ${themeStyles.accent} bg-dark-border/50`}>{lockMethods.size}/{lock.methods.length}</span>
                            <span className="text-dark-muted transition-transform" style={{ transform: isExpanded ? 'rotate(180deg)' : 'rotate(0deg)' }}>â–¼</span>
                          </div>
                        </div>
                      </div>

                      {isExpanded && (
                        <div className="bg-dark-bg/50 divide-y divide-dark-border/50">
                          {lock.methods.map(method => (
                            <div key={method.id} className="p-3 hover:bg-dark-border/20 transition-colors">
                              <div className="flex items-start gap-3">
                                <input
                                  type="checkbox"
                                  checked={lockMethods.has(method.id)}
                                  onChange={() => toggleMethod(lock.id, method.id)}
                                  className="w-4 h-4 rounded mt-1 cursor-pointer accent-grimoire-electric-blue"
                                />
                                <div className="flex-1">
                                  <div className="flex items-center justify-between mb-1">
                                    <h5 className="font-medium text-dark-text text-sm">{method.name}</h5>
                                    <span className={`text-xs font-semibold font-tech ${getDifficultyColor(method.difficulty)}`}>{method.difficulty.toUpperCase()}</span>
                                  </div>
                                  <p className="text-xs text-dark-muted mb-2">{method.description}</p>
                                  <div className="flex items-center gap-3 text-xs flex-wrap">
                                    <span className={`${themeStyles.accent}/20 ${themeStyles.accent} px-2 py-0.5 rounded`}>{method.successRate}% success</span>
                                    <span className="bg-grimoire-phoenix-orange/20 text-grimoire-phoenix-orange px-2 py-0.5 rounded font-tech">${method.price}</span>
                                    <span className="text-dark-muted">Req: {method.requirements.join(', ')}</span>
                                  </div>
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            )}
          </div>
          );
        })}
      </div>

      {Array.from(selectedMethods.values()).some(s => s.size > 0) && (
        <div className="grimoire-card border-grimoire-electric-blue/60 p-6 space-y-4 shadow-glow-blue">
          <button
            onClick={() => {
              onExecute?.(selectedMethods);
              console.log('[ExploitRegistry] Execute button clicked with selections:', selectedMethods);
              console.log('[ExploitRegistry] Total methods selected:', Array.from(selectedMethods.values()).reduce((acc, s) => acc + s.size, 0));
            }}
            className="w-full px-4 py-3 bg-gradient-to-r from-grimoire-electric-blue to-grimoire-neon-cyan hover:shadow-glow-blue text-dark-bg rounded-lg transition-all font-bold font-grimoire neon-glyph"
          >
            Execute Selected Methods ({Array.from(selectedMethods.values()).reduce((acc, s) => acc + s.size, 0)} total)
          </button>
          <p className="text-xs text-dark-muted">ðŸ’¡ Quick guide: 1-2 methods = "Cool & Easy" approach | 3-6+ = "Safe but Uneasy" multi-method strategy</p>
        </div>
      )}
    </div>
  );
}
